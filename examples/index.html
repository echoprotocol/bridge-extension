<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Echo Bridge!</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	</head>
	<body>
		<h1>Examples</h1>

		<!-- Accounts (current network) -->
		<div style="padding-bottom: 15px;">
			<h4>Accounts</h4>
			<div id="accounts"></div>
			<button id="accounts-click">submit</button>
		</div>

		<!-- Transfer -->
		<div style="padding-bottom: 10px; border-top: 1px solid #000;">
			<h4>Transfer</h4>
			<div style="padding: 5px 0;">
				<input
					type="text"
					id="transfer-fromAddress"
					name="transfer-fromAddress"
					placeholder="from"
					value="1.2.16"
				/>
				<input
					type="text"
					id="transfer-toAddress"
					name="transfer-toAddress"
					placeholder="to"
					value="1.2.17"
				/>
				<input
					type="number"
					id="transfer-amount-value"
					name="transfer-amount-value"
					placeholder="amount"
					value="1"
				/>
				<input
					type="text"
					id="transfer-amount-asset"
					name="transfer-amount-asset"
					placeholder="amount asset id"
					value="1.3.0"
				/>
				<input
					type="text"
					id="transfer-fee-asset"
					name="transfer-fee-asset"
					placeholder="fee asset id"
					value="1.3.0"
				/>
				<input
					type="text"
					id="transfer-memo"
					name="transfer-memo"
					placeholder="memo"
				/>
				<button id="transfer-click">submit</button>
			</div>
			<div id="transfer-info"></div>
		</div>
		<!---->

		<!-- Contract -->
		<div style="padding-bottom: 10px; border-top: 1px solid #000;">
			<h4>Contract</h4>
			<div style="padding: 5px 0;">
				<div>
					<input
						type="text"
						id="contract-registrar"
						name="contract-registrar"
						placeholder="registrar"
						value="1.2.16"
					/>
					<input
						type="text"
						id="contract-receiver"
						name="contract-receiver"
						placeholder="callee"
						value="1.16.68"
					/>
					<input
						type="text"
						id="contract-value"
						name="contract-value"
						placeholder="value"
						value="0"
					/>
					<input
						type="text"
						id="contract-asset"
						name="contract-asset"
						placeholder="asset id"
						value="1.3.0"
					/>
					<input
						type="text"
						id="contract-fee-asset"
						name="contract-fee-asset"
						placeholder="fee asset id"
						value="1.3.0"
					/>
				</div>
				<div style="padding: 5px 0;">
					<textarea
						id="contract-code"
						name="contract-code"
						placeholder="code"
						style="width: 600px; height: 150px;"
					></textarea>
				</div>
				<button id="contract-click">submit</button>
			</div>
			<div id="contract-info"></div>
		</div>
		<!---->
	</body>
	<script>
		window.onload = function() {
			window.echojslib.extension.subscribeSwitchNetwork(data => {
				console.log("subscriber: ", data);

				if (window.echojslib._ws._connected) {
					window.echojslib.disconnect();
				}

				window.echojslib.connect();

			});
		};

		$(document).ready(function() {
			$("#accounts-click").click(function(e) {
				window.echojslib.extension
					.getAccounts()
					.then(result => {
						jQuery("#accounts").html(
							`<p>RESULT: ${JSON.stringify(result)}</p>`
						);
					})
					.catch(err => {
						jQuery("#accounts").html(`<p>ERROR: ${JSON.stringify(err)}</p>`);
					});
			});

			$("#transfer-click").click(function(e) {
				const transaction = {
					type: 0,
					from: jQuery("#transfer-fromAddress")[0].value,
					amount: {
						amount: jQuery("#transfer-amount-value")[0].value,
						asset_id: jQuery("#transfer-amount-asset")[0].value
					},
					to: jQuery("#transfer-toAddress")[0].value
				};

				if (jQuery("#transfer-memo")[0].value) {
					transaction.memo = jQuery("#transfer-memo")[0].value;
				}

				if (jQuery("#transfer-fee-asset")[0].value) {
					transaction.fee = {
						amount: 0,
						asset_id: jQuery("#transfer-fee-asset")[0].value
					};
				}

				const tr = window.echojslib.createTransaction();

				const trSign = {
					from: transaction.from,
					to: transaction.to,
					amount: {
						asset_id: transaction.amount.asset_id,
						amount: transaction.amount.amount
					},
					fee: { asset_id: transaction.fee.asset_id }
				};

				if (transaction.memo) {
					trSign.memo = {
						from: "ECHO859gxfnXyUriMgUeThh1fWv3oqcpLFyHa3TfFYC4PK2HqhToVM",
						to: "ECHO59St8wBpta2ZREBnA3dQQTVFBrEcx5UK12Tm5geG7kv7Hwyzyc",
						nonce: window.echojslib.generateNonce(),
						message: window.echojslib.Buffer.from(
							transaction.memo,
							"utf8"
						).toString("hex")
					};
				}

				tr.addOperation(transaction.type, trSign);

				tr.signWithBridge()
						.then(result => {
							result.broadcast()
									.then((res) => {
										jQuery("#transfer-info").html(
												`<p>RESULT: ${JSON.stringify(res)}</p>`
										);
									})
									.catch((err) => {
										jQuery("#transfer-info").html(
												`<p>ERROR: ${JSON.stringify(err)}</p>`
										);
									});
						}).catch((err) => {
							jQuery("#transfer-info").html(
									`<p>ERROR: ${JSON.stringify(err.message)}</p>`
							);
						});
			});

			$("#contract-click").click(function(e) {
				const transaction = {
					type: 48,
					registrar: jQuery("#contract-registrar")[0].value,
					code: jQuery("#contract-code")[0].value,
					value: {
						amount: jQuery("#contract-value")[0].value,
						asset_id: jQuery("#contract-asset")[0].value
					}
				};

				if (jQuery("#contract-receiver")[0].value) {
					transaction.receiver = jQuery("#contract-receiver")[0].value;
				}

				if (jQuery("#contract-fee-asset")[0].value) {
					transaction.fee = {
						amount: 0,
						asset_id: jQuery("#contract-fee-asset")[0].value
					};
				}

				const tr = window.echojslib.createTransaction();

				tr.addOperation(48, {
					registrar: transaction.registrar,
					value: {
						asset_id: transaction.value.asset_id,
						amount: transaction.value.amount
					},
					code: transaction.code,
					callee: transaction.receiver
				});

				tr.signWithBridge()
					.then(result => {
						jQuery("#contract-info").html(
							`<p>RESULT: ${JSON.stringify(result)}</p>`
						);
					})
					.catch(err => {
						jQuery("#contract-info").html(
							`<p>ERROR: ${JSON.stringify(err)}</p>`
						);
					});
			});
		});
	</script>
</html>
